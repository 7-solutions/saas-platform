# Development Dockerfile for Website
FROM node:22-alpine AS development

# Install system dependencies for native modules and build tools
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    libc6-compat \
    pkgconfig \
    pixman-dev \
    cairo-dev \
    pango-dev

# Enable corepack and install pnpm 9.15.0
RUN corepack enable && \
    corepack prepare pnpm@9.15.0 --activate

# Set working directory
WORKDIR /app

# Copy package files first for better caching
COPY package.json pnpm-lock.yaml* pnpm-workspace.yaml ./
COPY apps/website/package.json ./apps/website/
COPY packages/ui/package.json ./packages/ui/
COPY packages/shared/package.json ./packages/shared/

# Install dependencies with BuildKit cache mount
RUN --mount=type=cache,id=pnpm,target=/root/.local/share/pnpm/store \
    pnpm install --frozen-lockfile

# Copy source code
COPY . .

# Expose port
EXPOSE 3000

# Set working directory to root for pnpm workspace commands
WORKDIR /app

# Start development server using pnpm workspace
CMD ["sh", "-c", "cd /app && pnpm --filter @saas-platform/website dev"]