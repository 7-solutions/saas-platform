# Integration Test Dockerfile
FROM node:22-alpine AS integration-test

# Install system dependencies needed for integration testing
RUN apk add --no-cache \
    libc6-compat \
    dumb-init \
    curl \
    bash && \
    # Enable corepack and prepare pnpm
    corepack enable && \
    corepack prepare pnpm@9.15.0 --activate

# Set working directory
WORKDIR /app

# Copy package configuration files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/website/package.json ./apps/website/
COPY apps/cms/package.json ./apps/cms/
COPY packages/ui/package.json ./packages/ui/
COPY packages/shared/package.json ./packages/shared/

# Install dependencies
RUN --mount=type=cache,id=pnpm-store-integration,target=/root/.local/share/pnpm/store \
    --mount=type=cache,id=pnpm-metadata-integration,target=/root/.cache/pnpm \
    pnpm install --frozen-lockfile --prefer-offline

# Copy source code and test files
COPY . .

# Create test results directory
RUN mkdir -p test-results

# Test environment variables
ENV NODE_ENV=test \
    CI=true

# Use dumb-init for proper signal handling
ENTRYPOINT ["dumb-init", "--"]

# Default command runs integration tests
CMD ["pnpm", "test:integration"]