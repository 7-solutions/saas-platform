# End-to-End Test Dockerfile with Playwright
FROM mcr.microsoft.com/playwright:v1.40.0-jammy AS e2e-test

# Install Node.js and pnpm
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - && \
    apt-get install -y nodejs && \
    corepack enable && \
    corepack prepare pnpm@9.15.0 --activate

# Set working directory
WORKDIR /app

# Copy package configuration files for optimal caching
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/website/package.json ./apps/website/
COPY apps/cms/package.json ./apps/cms/
COPY packages/ui/package.json ./packages/ui/
COPY packages/shared/package.json ./packages/shared/

# Install dependencies with E2E test specific packages
RUN --mount=type=cache,id=pnpm-store-e2e,target=/root/.local/share/pnpm/store \
    --mount=type=cache,id=pnpm-metadata-e2e,target=/root/.cache/pnpm \
    pnpm install --frozen-lockfile --prefer-offline

# Install Playwright browsers
RUN npx playwright install --with-deps

# Copy source code
COPY . .

# Create test results directory
RUN mkdir -p test-results

# E2E test environment variables
ENV NODE_ENV=test \
    NEXT_TELEMETRY_DISABLED=1 \
    CI=true \
    PLAYWRIGHT_BROWSERS_PATH=/ms-playwright \
    WEBSITE_URL=http://localhost:3000 \
    CMS_URL=http://localhost:3001 \
    BACKEND_URL=http://backend-test:8080

# Default command runs E2E tests
CMD ["pnpm", "test:e2e", "--reporter=html"]